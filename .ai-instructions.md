# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What is wow

wow is "uv for Ruby, in C" — a single Actually Portable Executable (APE) that replaces gem, bundler, rbenv, ruby-build, and gem push. Built with Cosmopolitan libc, the `wow.com` binary runs on Linux, macOS, and Windows (x86-64 + aarch64) from one file with zero external dependencies.

Design mantra: "We are slaves to uv. Whatever uv does, wow does." But we're still Rubyists — standard Gemfile, Gemfile.lock, vendor/, .ruby-version conventions are preserved.

## Build Commands

```bash
./configure                     # detect cosmocc toolchain + cosmo source tree
make                            # build build/wow.com (APE binary with embedded SSL roots)
make test                       # run all tests (tls, registry, ruby-mgr)
make test-tls                   # TLS certificate validation tests only
make test-registry              # rubygems.org JSON parsing tests only
make test-ruby-mgr              # Ruby manager + tar extraction tests
make clean                      # remove build/
make distclean                  # remove build/ + config.mk

make -C demos                   # build all phase demos (requires main make first)
make -C demos phase0            # build Phase 0 standalone demos
make -C demos phase3            # build Phase 3 parallel download demo
```

The build requires the Cosmopolitan source tree and cosmocc toolchain. `./configure` writes `config.mk` with `COSMO` (toolchain dir) and `COSMO_SRC` (source tree). If `config.mk` is absent, hardcoded fallback paths are used.

**User preference:** The user runs build commands themselves and pastes output back. Don't automatically run `make` unless explicitly asked.

## Architecture

### Toolchain: cosmocc + cosmoar + zipcopy

cosmocc produces fat binaries (x86-64 + aarch64 in one file). Every `.o` file has an `.aarch64/` companion automatically. `cosmoar` archives them. `zipcopy` embeds zip content into the APE binary's `/zip/` filesystem.

### Two sets of CFLAGS

- **CFLAGS** (`-std=c17 -Werror`) — for wow's own `src/**/*.c` files
- **COSMO_CFLAGS** (`-std=gnu17 -include stdbool.h -Wa,-W -Wa,--noexecstack`) — for compiling cosmo's source files out-of-tree. Key differences from cosmo's internal `-std=gnu23`: stdbool.h bridges `bool`/`true`/`false`, `-Wa,-W` suppresses assembler warnings from ecp256/ecp384 inline asm (matches cosmo's `build/definitions.mk:143-146`)

### mbedTLS: out-of-tree compilation

All ~97 mbedTLS + ~22 net/https source files from `$(COSMO_SRC)` are compiled with cosmocc into `build/libtls.a`. This avoids:
- Pre-built `.a` files from cosmo's `o/` tree (cause symbol conflicts with libcosmo.a)
- Invoking cosmo's own `make` (triggers 386-second full dependency scan)

`getentropy.c` is excluded from the HTTPS build because it calls `arc4random_buf` which isn't in cosmocc's libcosmo.a. Our `src/http/entropy.c` provides `GetEntropy()` using `getentropy(2)` instead.

### SSL root CA certificates

Root CAs from `$(COSMO_SRC)/usr/share/ssl/root/*.pem` are zipped and embedded into the APE via `zipcopy` post-link. `GetSslRoots()` reads them from `/zip/usr/share/ssl/root/` at runtime. Without this step, HTTPS fails with "certificate not correctly signed by trusted CA".

### Source layout

Source is organised into domain subdirectories (see "Code Organisation" below for the philosophy). Key modules:

| Directory | Key files | Role |
|-----------|-----------|------|
| `src/` | `main.c` | CLI entry point, subcommand dispatch, argv[0] shim mode |
| | `init.c` | `wow init` — Gemfile + .ruby-version + eager Ruby install |
| | `registry.c` | rubygems.org JSON API client (cJSON) |
| | `version.c` | Latest CRuby version from GitHub releases API |
| | `tar.c` | Streaming tar extraction — gzip and plain (security-hardened) |
| | `util.c` | Shared utilities (`wow_mkdirs`, `wow_now_secs`, etc.) |
| `src/http/` | `client.c`, `pool.c`, `entropy.c` | HTTPS client, connection pool, mbedTLS entropy shim |
| `src/download/` | `multibar.c`, `parallel.c`, `progress.c` | uv-style progress bars, bounded-concurrency worker pool |
| `src/rubies/` | `cmd.c`, `resolve.c`, `install.c`, `install_many.c`, `uninstall.c`, `list.c`, `shims.c`, `internal.c` | Ruby version management (replaces rbenv + ruby-build) |
| `src/gems/` | `cmd.c`, `download.c`, `list.c`, `meta.c`, `unpack.c` | .gem download, inspect, parse gemspec (libyaml), unpack |

Headers mirror the source layout: `include/wow/http/`, `include/wow/download/`, `include/wow/rubies/`. Umbrella headers (`wow/http.h`, `wow/download.h`, `wow/rubies.h`) include all submodule headers.

### Phase roadmap

Phases 0-3 are complete. Phase 7 was merged into Phase 3. See `docs/plan/MASTER_PLAN.md` for the full plan and `docs/plan/PLAN_PHASE*.md` for per-phase details.

| Phase | What | Status |
|-------|------|--------|
| 0 | Research demos (tar, lockparse, compact index, platform) | Done |
| 1 | Skeleton build + dispatch + `wow init` | Done |
| 2 | Native HTTPS + registry client + connection pool | Done |
| 3 | Ruby version manager + parallel downloads (merged Phase 7) | Done |
| 4 | .gem download + unpack (tar + libyaml) | Done |
| 5 | Gemfile parser (re2c + lemon) | Next |
| 6 | PubGrub dependency resolver | |
| 8 | End-to-end `wow sync` | |

## Conventions

- **en_IE** for comments, docs, and identifiers (colour, behaviour, initialise, etc.)
- Headers in `include/wow/`, vendored code in `vendor/`
- Public API: `wow_` prefix (e.g. `wow_http_get`, `wow_gem_info_fetch`)
- All build artefacts go in `build/` — never modify the cosmo source tree
- Demos in `demos/` with per-phase subdirectories (`phase0/`, etc.)
- Test binaries also get SSL roots via zipcopy
- cJSON is vendored (not a submodule) in `vendor/cjson/`

## Code Organisation: We ❤️ DRYing + Splitting

As the codebase grows, we actively:

1. **DRY up repetitions** — Shared macros (e.g., `WOW_WPATH`, `WOW_ANSI_*`), utility functions (`wow_now_secs()`, `wow_mkdirs()`), and helpers live in `include/wow/common.h` and `src/util.c`

2. **Split by responsibility** — When a file exceeds ~500 lines or mixes distinct concerns, split it:
   - `src/rubies/install.c` → `install.c` + `list.c` + `uninstall.c` + `cmd.c`
   - Shared rubies helpers → `src/rubies/internal.c`

3. **Directory structure reflects domains**:
   ```
   src/
   ├── http/      # HTTP client, TLS, connection pool
   ├── download/  # Progress bars, parallel downloads
   ├── rubies/    # Ruby version management
   └── util.c     # Shared utilities
   ```

## Reference: uv Source

wow is "slaves to uv" — design decisions, CLI behaviour, and feature parity are guided by the uv codebase. A reference copy of uv source lives at `../uv` (sibling to this project root).

**How we steal from uv:**

1. **Source code inspection** — When figuring out how to implement something in wow, inspect the reference copy at `../uv` to see how uv does it. (Good artists copy, great artists steal!)

2. **MCP documentation lookup** — Use Context7 MCP tooling (`resolve-library-id` / `query-docs` for library `/llmstxt/astral_sh_uv_llms_txt`) to quickly look up uv documentation and verify information.

3. **CLI behaviour reference** — Run `uv --help` or `uv [command] --help` to discover CLI structure, flags, and behaviour that wow slavishly adheres to.

## Agent Relay

This project uses `agent-relay-ftw` for Claude-Kimi collaboration. The relay skill is installed at `.claude/skills/agent-relay-ftw/`. Protocol reference at `.claude/skills/PROTOCOLv2.md`. Use the `agent-relay-ftw` skill (not manual file ops) to send messages. Always use relative paths for relay files (`tmp/relay/...`).
