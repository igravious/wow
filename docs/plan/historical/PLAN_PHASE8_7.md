# Phase 8.7: Ruby Runtime Compatibility — Making `require` Work

> The missing link: gems are installed, but Ruby can't find them.
> Status: Planning — Not Started

**Depends on**: Phase 8 (wow sync installing to vendor/bundle), Phase 4 (gem unpacking)
**Blocks**: Phase 8d (wow run — needs this to actually work), Production use

---

## The Problem

Phase 8 installs gems to `vendor/bundle/ruby/X.Y.0/gems/`, but:

```bash
$ wow run ruby -e "require 'sinatra'"
# LoadError: cannot load such file -- sinatra
```

Bundler solves this via `Bundler.setup` which:
1. Adds all gem `lib/` directories to `$LOAD_PATH` in dependency order
2. Populates `Gem.loaded_specs` for runtime introspection
3. Provides `Gem::Specification.find_by_name` for gems to locate each other
4. Generates `bin/` stubs that set up the environment

wow needs equivalents for all of these.

---

## 8.7a: `$LOAD_PATH` Setup (Bundler.setup Equivalent)

### Approach: Environment Variable, Not Ruby Code

Bundler uses Ruby code (`Bundler.setup`). wow uses shell environment:

```bash
# wow run sets this:
export RUBYLIB="vendor/bundle/ruby/4.0.0/gems/rack-3.1.12/lib:vendor/bundle/ruby/4.0.0/gems/sinatra-4.1.1/lib:..."
```

**Generation:** After `wow sync`, generate a load-path file:

```bash
# vendor/bundle/ruby/4.0.0/.load-path
# One path per line, in dependency resolution order
vendor/bundle/ruby/4.0.0/gems/rack-3.1.12/lib
vendor/bundle/ruby/4.0.0/gems/tilt-2.6.0/lib
vendor/bundle/ruby/4.0.0/gems/mustermann-3.0.3/lib
vendor/bundle/ruby/4.0.0/gems/sinatra-4.1.1/lib
```

**wow run implementation:**

```c
/* src/run.c — Environment setup for wow run */

int wow_run_setup_env(const char *bundle_path, const char *ruby_version) {
    /* Read .load-path file */
    /* Build colon-separated RUBYLIB string */
    /* setenv("RUBYLIB", ...) */
    /* setenv("GEM_HOME", bundle_path) — for Bundler compatibility */
    /* setenv("GEM_PATH", bundle_path) */
    /* setenv("BUNDLE_GEMFILE", "./Gemfile") */
    /* Prepend ruby/bin to PATH */
}
```

### Group Handling

Bundler supports `BUNDLE_WITHOUT=development:test` to skip groups.

```bash
# Generate multiple load-path files:
.load-path.default
.load-path.development
.load-path.test

# wow run uses .load-path.default unless --with-development flag
```

---

## 8.7b: `Gem.loaded_specs` & `Gem::Specification` Support

### The Hard Problem

```ruby
# Rails does this:
spec = Gem::Specification.find_by_name('sass-rails')
assets_path = File.join(spec.gem_dir, 'lib', 'assets')
```

This requires a `specifications/` directory with `.gemspec` files in standard RubyGems format.

### Option A: Full GEM_HOME Structure (Recommended)

After `wow sync`, create:

```
vendor/bundle/ruby/4.0.0/
├── gems/                    # Already exists
│   ├── rack-3.1.12/
│   ├── sinatra-4.1.1/
│   └── ...
├── specifications/          # NEW — .gemspec files
│   ├── rack-3.1.12.gemspec
│   ├── sinatra-4.1.1.gemspec
│   └── ...
└── bin/                     # NEW — bin stubs
    ├── rackup
    ├── sinatra
    └── ...
```

**Generating specifications:**

```c
/* src/bundle/setup.c */

int wow_bundle_generate_specs(const char *bundle_path) {
    /* For each gem in vendor/bundle/ruby/X.Y.0/gems/ */
    /*   Parse metadata.yaml from .gem (cached in ~/.cache/wow/gems/) */
    /*   Write simplified .gemspec to specifications/ */
    /*   Format compatible with Gem::Specification.load */
}
```

**Simplified .gemspec format** (just what RubyGems needs):

```ruby
# specifications/rack-3.1.12.gemspec
Gem::Specification.new do |s|
  s.name = "rack"
  s.version = Gem::Version.new("3.1.12")
  s.platform = "ruby"
  s.authors = ["Leah Neukirchen"]
  s.email = ["leah@vuxu.org"]
  s.homepage = "https://rack.github.io"
  s.summary = "Rack provides a minimal interface..."
  s.files = []  # Not needed for runtime
  s.require_paths = ["lib"]
  s.bindir = "bin"
  s.executables = ["rackup"]
  s.dependencies = [
    Gem::Dependency.new("webrick", Gem::Requirement.new([">= 0"]), :runtime)
  ]
end
```

### Option B: Shim RubyGem (Deferred)

Create a Ruby file that wow's `RUBYOPT` requires:

```bash
export RUBYOPT="-r/path/to/wow/setup.rb"
```

The `setup.rb` would monkey-patch `Gem::Specification` to read from wow's metadata.

**Deferred** — adds Ruby dependency, harder to debug.

---

## 8.7c: `bin/` Stubs Generation

Bundler generates `bin/rails`, `bin/rake`, etc. wow needs the same.

### Stub Template

```ruby
#!/usr/bin/env ruby
# GENERATED BY wow — do not edit

# Set up wow environment
ENV['GEM_HOME'] = File.expand_path('../vendor/bundle/ruby/4.0.0', __dir__)
ENV['GEM_PATH'] = ENV['GEM_HOME']
ENV['BUNDLE_GEMFILE'] = File.expand_path('../Gemfile', __dir__)

# Add wow's Ruby to PATH
ruby_bin = File.expand_path('~/.local/share/wow/rubies/ruby-4.0-linux-x86_64/bin')
ENV['PATH'] = "#{ruby_bin}:#{ENV['PATH']}"

# Load the actual executable
gem_name = 'railties'
executable = 'rails'

# Find gem path
$LOAD_PATH.unshift File.join(ENV['GEM_HOME'], 'gems', "#{gem_name}-*", 'lib')
require gem_name

load Gem.bin_path(gem_name, executable)
```

**C version (faster):**

```c
/* src/bundle/stub.c — Generate C stubs instead of Ruby */

/* Actually: Ruby stubs are fine, generation is one-time cost */
/* C shim wrapper for speed? Not worth it for MVP. */
```

### wow bundle install --binstubs

```bash
wow sync --binstubs bin/    # Generate bin/ stubs
wow sync --binstubs         # Default to bin/
```

Without `--binstubs`, `wow run rake` is the only way to run commands.

---

## 8.7d: `bundle exec` Emulation

**Current status:** Stub in ERGONOMICS doc.

**Full implementation:**

```bash
wow bundle exec rake db:migrate
# Exactly equivalent to:
wow run rake db:migrate
```

But also support:

```bash
wow bundle exec ruby script.rb
# Equivalent to:
wow run ruby script.rb
```

### BUNDLE_* Environment Variables

| Variable | Support | Notes |
|----------|---------|-------|
| `BUNDLE_GEMFILE` | ✅ | Custom Gemfile path |
| `BUNDLE_PATH` | ✅ | Custom vendor path (default: vendor/bundle) |
| `BUNDLE_WITHOUT` | ✅ | Skip groups: `development,test` |
| `BUNDLE_WITH` | ✅ | Include optional groups |
| `BUNDLE_DEPLOYMENT` | ✅ | Fail if Gemfile.lock missing/outdated |
| `BUNDLE_FROZEN` | ✅ | Same as DEPLOYMENT |
| `BUNDLE_CACHE_PATH` | ⛔️ | Not needed (wow uses XDG) |
| `BUNDLE_JOBS` | ⛔️ | Parallel install (wow always parallel) |
| `BUNDLE_RETRY` | ⛔️ | Retry count (handled by HTTP layer) |

---

## 8.7e: `Bundler.require` Equivalent

**Problem:** Rails apps expect:

```ruby
# config/application.rb
Bundler.require(*Rails.groups)
```

This auto-requires gems. wow needs to provide a replacement.

### Option: Generate `vendor/bundle/setup.rb`

```ruby
# vendor/bundle/setup.rb — Auto-generated by wow sync

# Set up load paths
$LOAD_PATH.unshift 'vendor/bundle/ruby/4.0.0/gems/rack-3.1.12/lib'
$LOAD_PATH.unshift 'vendor/bundle/ruby/4.0.0/gems/sinatra-4.1.1/lib'
# ... etc

# Auto-require gems (unless :require => false)
require 'rack'
require 'tilt'
# ... etc (skipping gems with :require => false)
```

**Usage:**

```ruby
# Instead of: require 'bundler/setup'
require_relative 'vendor/bundle/setup'
```

Or set `RUBYOPT`:

```bash
export RUBYOPT="-r./vendor/bundle/setup"
```

---

## Implementation Order

1. **8.7a** — RUBYLIB setup via `.load-path` file
   - Unblocks basic `require` statements
   - `wow run` becomes actually useful

2. **8.7b** — `specifications/` directory
   - Unblocks `Gem::Specification.find_by_name`
   - Rails works

3. **8.7c** — `bin/` stubs
   - Daily workflow parity with Bundler
   - `./bin/rails` works

4. **8.7d** — `bundle exec` emulation
   - Muscle memory compatibility
   - CI/CD compatibility

5. **8.7e** — `Bundler.require` equivalent
   - Rails apps work without modification
   - Optional: most apps use `bundler/setup` anyway

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/bundle/setup.c` | Create | Generate `.load-path`, `specifications/`, `bin/` stubs |
| `include/wow/bundle/setup.h` | Create | Setup generation API |
| `src/bundle/stub.rb.template` | Create | Ruby template for bin stubs |
| `src/run.c` | Create | `wow run` implementation (Phase 8d stub) |
| `src/bundle/exec.c` | Create | `wow bundle exec` implementation |
| `src/sync.c` | Modify | Call setup generation after install |
| `src/main.c` | Modify | Add `run` and `bundle exec` dispatch |

---

## Verification

```bash
# 1. Basic require works
wow sync
echo 'require "sinatra"' > test.rb
wow run ruby test.rb
# Should succeed (no LoadError)

# 2. Gem.loaded_specs populated
wow run ruby -e "puts Gem.loaded_specs['sinatra'].version"
# Should print: 4.1.1

# 3. Gem::Specification.find_by_name works
wow run ruby -e "puts Gem::Specification.find_by_name('rack').gem_dir"
# Should print full path

# 4. bin stubs work
wow sync --binstubs
./bin/rackup --version
# Should work without wow run

# 5. bundle exec works
wow bundle exec ruby test.rb
# Same as wow run ruby test.rb

# 6. BUNDLE_WITHOUT works
BUNDLE_WITHOUT=development wow run ruby test.rb
# Development gems not in load path
```

---

## Dependencies

- **Blocked by**: Phase 4 (gem unpacking), Phase 8 (wow sync)
- **Blocks**: Phase 8d (wow run — this IS the implementation)
- **Related**: Phase 8.4 (wowx — shares RUBYLIB approach but different scope)

---

## Post-MVP Enhancements

| Feature | Description | Priority |
|---------|-------------|----------|
| Cached load path | Skip parsing if .load-path matches lockfile | Low |
| Gem staleness check | `bundle check` equivalent — verify all gems present | Low |
| Path optimization | Sort $LOAD_PATH by expected usage frequency | Nice |
| Native extension loading | Set up `vendor/bundle/ruby/X.Y.0/extensions/` | Post-MVP (Phase 10?) |

---

## Open Questions

1. **Ruby version in stubs**: Hardcode or dynamically detect?
2. **Windows `.bat` stubs**: Need separate batch file generation?
3. **Shebang portability**: `#!/usr/bin/env ruby` vs hardcoded wow Ruby path?
4. **Bundler version compatibility**: Target Bundler 2.x or 4.x format?

---

*Last updated: 2026-02-21*
*Status: Draft — needs review*
