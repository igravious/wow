# Phase 9: Ruby Runtime Core — Making Gems Loadable

> The missing link between "gems are installed" and "Ruby can find them."
> Status: Planning — Not Started
> MVP: Blocker

**Depends on**: Phase 8 (wow sync), Phase 4 (gem unpacking)
**Blocks**: Phase 8d (wow run — this IS the implementation)

---

## 9a: RUBYLIB Setup — `$LOAD_PATH` Management

**Problem:** `wow sync` installs gems to `vendor/bundle/ruby/X.Y.0/gems/`, but `require 'sinatra'` fails.

**Solution:** Generate a load-path manifest and set `RUBYLIB` environment variable.

**Implementation:**

```bash
# After wow sync, generate:
vendor/bundle/ruby/4.0.0/.load-path
# One path per line, dependency order:
vendor/bundle/ruby/4.0.0/gems/rack-3.1.12/lib
vendor/bundle/ruby/4.0.0/gems/tilt-2.6.0/lib
vendor/bundle/ruby/4.0.0/gems/sinatra-4.1.1/lib
```

**wow run implementation:**

```c
/* src/run.c */
int cmd_run(int argc, char *argv[]) {
    /* Read .load-path */
    /* Build colon-separated RUBYLIB string */
    setenv("RUBYLIB", rubylib, 1);
    setenv("GEM_HOME", bundle_path, 1);
    setenv("GEM_PATH", bundle_path, 1);
    setenv("BUNDLE_GEMFILE", "./Gemfile", 1);
    /* Prepend ruby/bin to PATH */
    execvp(new_argv[0], new_argv);
}
```

**Group handling:**
- Generate `.load-path.default` (excludes development/test)
- Generate `.load-path.development` if `--with-development`
- Respect `BUNDLE_WITHOUT` environment variable

---

## 9b: specifications/ Directory — `Gem::Specification` Support

**Problem:** Rails and other gems call `Gem::Specification.find_by_name('sass-rails')` to locate assets.

**Solution:** Create standard RubyGems `specifications/` directory with `.gemspec` files.

**Structure:**

```
vendor/bundle/ruby/4.0.0/
├── gems/                    # Already exists
├── specifications/          # NEW
│   ├── rack-3.1.12.gemspec
│   ├── sinatra-4.1.1.gemspec
│   └── ...
└── bin/                     # NEW (see 9c)
```

**gemspec format** (simplified, compatible):

```ruby
# specifications/rack-3.1.12.gemspec
Gem::Specification.new do |s|
  s.name = "rack"
  s.version = Gem::Version.new("3.1.12")
  s.platform = "ruby"
  s.require_paths = ["lib"]
  s.bindir = "bin"
  s.executables = ["rackup"]
end
```

**Generation:** Parse `metadata.yaml` from cached `.gem` files, write simplified `.gemspec`.

---

## 9c: bin/ Stubs Generation

**Problem:** Users expect `./bin/rails`, not `wow run rails`.

**Solution:** Generate Bundler-compatible bin stubs.

**Generation:**

```bash
wow sync --binstubs bin/    # Generate to bin/
wow sync --binstubs         # Default to bin/
```

**Stub template:**

```ruby
#!/usr/bin/env ruby
# GENERATED BY wow — do not edit
ENV['GEM_HOME'] = File.expand_path('../vendor/bundle/ruby/4.0.0', __dir__)
ENV['GEM_PATH'] = ENV['GEM_HOME']
ENV['BUNDLE_GEMFILE'] = File.expand_path('../Gemfile', __dir__)
require 'rubygems'
load Gem.bin_path('railties', 'rails')
```

---

## 9d: bundle exec Emulation

**Implementation:**

```bash
wow bundle exec rake db:migrate
# Exactly equivalent to:
wow run rake db:migrate
```

**Environment variables supported:**

| Variable | Support |
|----------|---------|
| `BUNDLE_GEMFILE` | ✅ Custom Gemfile path |
| `BUNDLE_PATH` | ✅ Custom vendor path |
| `BUNDLE_WITHOUT` | ✅ Skip groups |
| `BUNDLE_WITH` | ✅ Include optional groups |
| `BUNDLE_DEPLOYMENT` | ✅ Fail if lockfile outdated |

---

## 9e: Bundler.require Equivalent

**Problem:** Rails apps call `Bundler.require(*Rails.groups)` in `config/application.rb`.

**Solution:** Generate `vendor/bundle/setup.rb` that mimics `bundler/setup`.

**Generated file:**

```ruby
# vendor/bundle/setup.rb — Auto-generated by wow sync
$LOAD_PATH.unshift 'vendor/bundle/ruby/4.0.0/gems/rack-3.1.12/lib'
$LOAD_PATH.unshift 'vendor/bundle/ruby/4.0.0/gems/sinatra-4.1.1/lib'
# ... etc

# Auto-require (skip :require => false)
require 'rack' unless $LOADED_FEATURES.any? { |f| f.include?('rack') }
```

**Usage:**

```ruby
# Instead of: require 'bundler/setup'
require_relative 'vendor/bundle/setup'
```

Or via `RUBYOPT`:

```bash
export RUBYOPT="-r./vendor/bundle/setup"
```

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/run.c` | Create | `wow run` implementation |
| `src/bundle/setup.c` | Create | Generate `.load-path`, `specifications/`, `bin/` stubs |
| `src/bundle/exec.c` | Create | `wow bundle exec` dispatch |
| `src/sync.c` | Modify | Call setup generation after install |
| `src/main.c` | Modify | Add `run` and `bundle exec` dispatch |

---

## Verification

```bash
# 1. Basic require works
wow sync
echo 'require "sinatra"' > test.rb
wow run ruby test.rb        # Success

# 2. Gem.loaded_specs populated
wow run ruby -e "puts Gem.loaded_specs['sinatra'].version"  # 4.1.1

# 3. Gem::Specification.find_by_name works
wow run ruby -e "puts Gem::Specification.find_by_name('rack').gem_dir"

# 4. bin stubs work
wow sync --binstubs
./bin/rackup --version        # Works without wow run

# 5. bundle exec works
wow bundle exec ruby test.rb  # Same as wow run

# 6. BUNDLE_WITHOUT works
BUNDLE_WITHOUT=development wow run ruby test.rb
```

---

*Last updated: 2026-02-21*
*Status: Draft*
