# Gemfile.lock Format Specification

Research document for **wow** (Phase 0b) -- understanding the Bundler lockfile
format so we can implement a correct parser and writer in C.

## Table of Contents

1. [Overview](#overview)
2. [Section Order](#section-order)
3. [Indentation Rules](#indentation-rules)
4. [GEM Section](#gem-section)
5. [GIT Section](#git-section)
6. [PATH Section](#path-section)
7. [PLATFORMS Section](#platforms-section)
8. [DEPENDENCIES Section](#dependencies-section)
9. [RUBY VERSION Section](#ruby-version-section)
10. [CHECKSUMS Section](#checksums-section)
11. [BUNDLED WITH Section](#bundled-with-section)
12. [PLUGIN SOURCE Section](#plugin-source-section)
13. [Version Constraint Syntax](#version-constraint-syntax)
14. [Platform Strings](#platform-strings)
15. [Edge Cases](#edge-cases)
16. [What wow Needs to Implement](#what-wow-needs-to-implement)
17. [Real-World Examples](#real-world-examples)
18. [Sources](#sources)

---

## Overview

`Gemfile.lock` is a plain-text, indentation-based lockfile generated by Bundler.
It records the exact versions of every gem resolved for a Ruby project, ensuring
reproducible installs across machines and environments.

The file is comprised of **sections**, each introduced by a header line with no
leading whitespace. Within sections, structure is conveyed entirely through
indentation (spaces, never tabs). There is no formal grammar specification
published by the Bundler project; the canonical definition is the source code of
`Bundler::LockfileParser` and the `to_lock` methods on each source class.

The format has evolved across Bundler versions:

| Section          | Introduced in Bundler |
|------------------|-----------------------|
| GIT              | 1.0                   |
| GEM              | 1.0                   |
| PATH             | 1.0                   |
| DEPENDENCIES     | 1.0                   |
| PLATFORMS        | 1.0                   |
| BUNDLED WITH     | 1.10                  |
| RUBY VERSION     | 1.12                  |
| PLUGIN SOURCE    | 1.13                  |
| CHECKSUMS        | 2.5.0 (hidden), 2.6 (opt-in), 4.0 (default) |

---

## Section Order

Bundler writes sections in this order:

1. **Source sections** -- GIT, then PATH, then GEM (and PLUGIN SOURCE if present).
   Multiple GIT/PATH/GEM blocks may appear; each is separated by a blank line.
2. **PLATFORMS**
3. **DEPENDENCIES**
4. **RUBY VERSION** (optional)
5. **CHECKSUMS** (optional, Bundler >= 2.6)
6. **BUNDLED WITH**

Each section is separated from the next by a **single blank line**. The file ends
with a trailing newline after the last section.

Within the source sections, GIT blocks come first (one per git remote), then PATH
blocks (one per path source), then GEM blocks (one per rubygems remote, or one
combined block with multiple `remote:` lines for the legacy format).

---

## Indentation Rules

The lockfile uses a strict, space-based indentation scheme. **Tabs are never used.**

| Indent Level | Spaces | Used For |
|--------------|--------|----------|
| 0            | 0      | Section headers (`GEM`, `GIT`, `PATH`, `PLATFORMS`, etc.) |
| 1            | 2      | Section metadata (`remote:`, `revision:`, `specs:`) and entries in PLATFORMS, DEPENDENCIES |
| 2            | 4      | Gem specifications within a `specs:` block (name, version, platform) |
| 3            | 6      | Dependencies of a gem specification |

The Bundler parser uses a regex that matches **exactly** 2, 4, or 6 leading
spaces -- from `lockfile_parser.rb`:

```ruby
NAME_VERSION = /
  ^(#{space}{2}|#{space}{4}|#{space}{6})(?!#{space})
  (.*?)                          # name
  (?:#{space}\(([^-]*)           # version
  (?:-(.*))?\))?                 # platform
  (!)?                           # pinned marker
  (?:#{space}([^ ]+))?           # optional checksum
  $
/xo
```

### Indentation change in Bundler 4

Historically, the `RUBY VERSION` and `BUNDLED WITH` sections used **3-space
indentation** for their values. Bundler 4 corrected this to **2-space
indentation** for consistency. The wow parser must handle both 2-space and
3-space indentation in these sections for backwards compatibility.

---

## GEM Section

The GEM section lists gems sourced from a RubyGems-compatible repository
(typically `https://rubygems.org/`).

### Structure

```
GEM
  remote: <url>
  specs:
    <gem_name> (<version>)
      <dep_name> (<constraint>)
      <dep_name> (<constraint>, <constraint>)
    <gem_name> (<version>-<platform>)
      <dep_name> (<constraint>)
```

### Fields

- **`remote:`** (2-space indent) -- The URL of the gem source. There can be
  multiple `remote:` lines under a single GEM block (legacy format) or separate
  GEM blocks per remote (modern format, Bundler >= 2.2.14).
- **`specs:`** (2-space indent) -- Introduces the list of resolved gems.
- **Gem entry** (4-space indent) -- `name (version)` or `name (version-platform)`.
- **Gem dependency** (6-space indent) -- `dep_name (constraint)`.

### Example (from our project's Gemfile.lock)

```
GEM
  remote: https://rubygems.org/
  specs:
    ffi (1.17.3)
    ffi (1.17.3-aarch64-linux-gnu)
    ffi (1.17.3-aarch64-linux-musl)
    ffi (1.17.3-arm-linux-gnu)
    ffi (1.17.3-arm-linux-musl)
    ffi (1.17.3-arm64-darwin)
    ffi (1.17.3-x86-linux-gnu)
    ffi (1.17.3-x86-linux-musl)
    ffi (1.17.3-x86_64-darwin)
    ffi (1.17.3-x86_64-linux-gnu)
    ffi (1.17.3-x86_64-linux-musl)
    rb-inotify (0.11.1)
      ffi (~> 1.0)
```

### Multiple remotes (legacy format)

In the older format, a single GEM block can have multiple `remote:` lines:

```
GEM
  remote: https://rubygems.org/
  remote: https://gems.example.com/
  specs:
    my_gem (1.0.0)
    rack (2.2.3)
```

> **wow policy:** The parser must accept this legacy format when **reading**
> existing lockfiles. When **writing**, wow always produces the modern format
> (separate GEM blocks per source) — no need to emit legacy multi-remote blocks.

### Multiple GEM blocks (modern format, Bundler >= 2.2.14)

When using scoped sources in the Gemfile, each source gets its own GEM block:

```
GEM
  remote: https://gem.fury.io/myorg/
  specs:
    private_gem (0.1.0)

GEM
  remote: https://rubygems.org/
  specs:
    rack (2.2.3)
```

### Gem entry format details

The version string inside parentheses follows `Gem::Version` syntax. For
platform-specific gems, a dash-separated platform string follows the version:

```
    nokogiri (1.18.7)                         # pure Ruby / source build
    nokogiri (1.18.7-x86_64-linux-gnu)        # precompiled for x86_64-linux-gnu
    nokogiri (1.18.7-arm64-darwin)             # precompiled for arm64-darwin
```

The generic (no platform suffix) entry represents the source gem that requires
compilation. Platform-specific entries are precompiled native gems.

Gems within `specs:` are sorted **alphabetically by name**, then by platform
string. Each gem with dependencies lists them at 6-space indent immediately
below.

---

## GIT Section

The GIT section describes gems sourced from a git repository.

### Structure

```
GIT
  remote: <git_url>
  revision: <40-char SHA>
  branch: <branch_name>       # optional
  tag: <tag_name>             # optional
  ref: <ref>                  # optional
  submodules: true            # optional
  glob: <glob_pattern>        # optional, only if non-default
  specs:
    <gem_name> (<version>)
      <dep_name> (<constraint>)
```

### Fields

- **`remote:`** -- The git repository URL (HTTPS or SSH).
- **`revision:`** -- The exact 40-character SHA-1 commit hash that is locked.
  Always present.
- **`branch:`** -- The branch name, if specified in the Gemfile. Optional.
- **`tag:`** -- The tag name, if specified in the Gemfile. Optional.
- **`ref:`** -- A ref, if specified in the Gemfile. Optional.
- **`submodules:`** -- Present (with value `true`) if submodules should be
  checked out.
- **`glob:`** -- A custom glob pattern for finding gemspec files. Only present
  if it differs from the default (`*.gemspec`).
- **`specs:`** -- Followed by gem entries at 4-space indent and their
  dependencies at 6-space indent, identical to the GEM section.

### Field order in output

The `to_lock` method in `Bundler::Source::Git` outputs fields in this order:
`remote`, `revision`, then optionally `ref`, `branch`, `tag`, `submodules`,
then `glob` (if non-default), then `specs`.

### Example

```
GIT
  remote: https://github.com/rails/sdoc.git
  revision: cd75e36ce2d1acb66734c1390ffe33aa05479380
  branch: main
  specs:
    sdoc (3.0.0.alpha)
      nokogiri
      rdoc (>= 5.0)
      rouge
```

### Multiple GIT blocks

Each distinct git remote gets its own GIT block. If the Gemfile references three
different git repositories, there will be three GIT blocks in the lockfile.

---

## PATH Section

The PATH section describes gems sourced from a local filesystem path.

### Structure

```
PATH
  remote: <relative_or_absolute_path>
  glob: <glob_pattern>              # optional, only if non-default
  specs:
    <gem_name> (<version>)
      <dep_name> (<constraint>)
```

### Fields

- **`remote:`** -- The filesystem path, typically relative to the project root.
  A common value is `.` (current directory) for gems developed in-place.
- **`glob:`** -- Custom glob for finding gemspec files. Only present if it
  differs from the default.
- **`specs:`** -- Gem entries and dependencies, same format as GEM/GIT sections.

### Example (from Devise's Gemfile.lock)

```
PATH
  remote: .
  specs:
    devise (5.0.0.beta)
      bcrypt (~> 3.0)
      orm_adapter (~> 0.1)
      railties (>= 6.0.0)
      responders
      warden (~> 1.2.3)
```

### Example (from Rails' Gemfile.lock -- multiple PATH gems)

The `rails/rails` repository uses `PATH remote: .` to source all framework gems
(actioncable, actionmailer, actionpack, activerecord, activesupport, railties,
etc.) from the monorepo root. Each gem and its dependencies are listed under a
single PATH block.

---

## PLATFORMS Section

Lists the target platforms for which dependencies have been resolved.

### Structure

```
PLATFORMS
  <platform_string>
  <platform_string>
  ...
```

Each platform string is at 2-space indent, one per line. Platforms are listed
in **alphabetical order**.

### Example (from our project)

```
PLATFORMS
  aarch64-linux-gnu
  aarch64-linux-musl
  arm-linux-gnu
  arm-linux-musl
  arm64-darwin
  ruby
  x86-linux-gnu
  x86-linux-musl
  x86_64-darwin
  x86_64-linux-gnu
  x86_64-linux-musl
```

The special platform `ruby` means "any platform running MRI/CRuby" and is used
for pure-Ruby gems or source-compiled native gems.

See the [Platform Strings](#platform-strings) section for more detail.

---

## DEPENDENCIES Section

Lists the top-level gems declared in the Gemfile, along with their version
constraints (if any).

### Structure

```
DEPENDENCIES
  <gem_name>
  <gem_name> (<constraint>)
  <gem_name> (<constraint>, <constraint>)!
  <gem_name>!
```

Each dependency is at 2-space indent, one per line. Dependencies are listed
in **alphabetical order**.

### The `!` (pinned) marker

A trailing `!` indicates the gem is **pinned to a non-default source** (i.e.,
it comes from a `:git`, `:path`, or scoped `:source` block rather than the
global RubyGems source). This tells Bundler to only look for that gem in its
designated source.

### Examples

```
DEPENDENCIES
  capybara (~> 2.3)
  devise!
  my_private_gem (~> 0.2)!
  puma (~> 5.0)
  rails (~> 7.0)
  rb-inotify
  sidekiq (>= 6.0, < 8.0)
```

Here:
- `rb-inotify` -- no version constraint, from default source.
- `rails (~> 7.0)` -- pessimistic constraint, from default source.
- `devise!` -- pinned to a non-default source (likely `:path` or `:git`), no
  explicit version constraint in the lockfile.
- `my_private_gem (~> 0.2)!` -- pinned to a non-default source with a version
  constraint.
- `sidekiq (>= 6.0, < 8.0)` -- multiple constraints separated by commas.

### Constraint format in DEPENDENCIES

The version constraints here mirror those from the Gemfile, **not** exact
resolved versions. They represent what was declared, not what was resolved.

---

## RUBY VERSION Section

An optional section recording the Ruby version used when the lockfile was
generated.

### Structure (Bundler < 4)

```
RUBY VERSION
   ruby 3.2.2p53
```

Note: Historically uses **3-space indentation** (not 2).

### Structure (Bundler >= 4)

```
RUBY VERSION
  ruby 3.2.2
```

Bundler 4 changed to **2-space indentation** and removed the patch level (e.g.,
`p53`), since Ruby's versioning policy makes the patch level irrelevant.

### When it appears

This section is present when the Gemfile contains a `ruby` directive, e.g.:

```ruby
ruby "3.2.2"
```

If no `ruby` directive exists in the Gemfile, this section is omitted entirely.

---

## CHECKSUMS Section

An optional section (Bundler >= 2.6, default in Bundler 4) that records SHA-256
checksums for each gem to detect tampering.

### Structure

```
CHECKSUMS
  <gem_name> (<version>) sha256=<64-char hex digest>
  <gem_name> (<version>-<platform>) sha256=<64-char hex digest>
```

Each entry is at 2-space indent, one per line. Entries are sorted alphabetically
by gem name, then by platform.

### Example (from our project)

```
CHECKSUMS
  ffi (1.17.3) sha256=0e9f39f7bb3934f77ad6feab49662be77e87eedcdeb2a3f5c0234c2938563d4c
  ffi (1.17.3-aarch64-linux-gnu) sha256=28ad573df26560f0aedd8a90c3371279a0b2bd0b4e834b16a2baa10bd7a97068
  ffi (1.17.3-aarch64-linux-musl) sha256=020b33b76775b1abacc3b7d86b287cef3251f66d747092deec592c7f5df764b2
  ffi (1.17.3-arm-linux-gnu) sha256=5bd4cea83b68b5ec0037f99c57d5ce2dd5aa438f35decc5ef68a7d085c785668
  ffi (1.17.3-arm-linux-musl) sha256=0d7626bb96265f9af78afa33e267d71cfef9d9a8eb8f5525344f8da6c7d76053
  ffi (1.17.3-arm64-darwin) sha256=0c690555d4cee17a7f07c04d59df39b2fba74ec440b19da1f685c6579bb0717f
  ffi (1.17.3-x86-linux-gnu) sha256=868a88fcaf5186c3a46b7c7c2b2c34550e1e61a405670ab23f5b6c9971529089
  ffi (1.17.3-x86-linux-musl) sha256=f0286aa6ef40605cf586e61406c446de34397b85dbb08cc99fdaddaef8343945
  ffi (1.17.3-x86_64-darwin) sha256=1f211811eb5cfaa25998322cdd92ab104bfbd26d1c4c08471599c511f2c00bb5
  ffi (1.17.3-x86_64-linux-gnu) sha256=3746b01f677aae7b16dc1acb7cb3cc17b3e35bdae7676a3f568153fb0e2c887f
  ffi (1.17.3-x86_64-linux-musl) sha256=086b221c3a68320b7564066f46fed23449a44f7a1935f1fe5a245bd89d9aea56
  rb-inotify (0.11.1) sha256=a0a700441239b0ff18eb65e3866236cd78613d6b9f78fea1f9ac47a85e47be6e
```

### Checksum format

The format is: `gem_name (version[-platform]) sha256=<hex>`. Currently only
SHA-256 is used; the algorithm prefix (`sha256=`) allows for future algorithm
additions.

> **wow policy:** Parse the algorithm prefix generically (split on `=`) to
> handle potential future algorithms (e.g. `sha512=`, `blake2b=`). Only
> **verify** `sha256=` checksums for now; log a warning on unknown prefixes.

### Enabling checksums

- `bundle lock --add-checksums` -- adds CHECKSUMS to an existing lockfile.
- `bundle config lockfile_checksums true` -- enables checksums for all new
  lockfiles.
- In Bundler 4, CHECKSUMS are included by default for new lockfiles.

---

## BUNDLED WITH Section

Records the version of Bundler that generated the lockfile.

### Structure (Bundler < 4)

```
BUNDLED WITH
   2.5.3
```

Note: Historically uses **3-space indentation**.

### Structure (Bundler >= 4)

```
BUNDLED WITH
  4.0.3
```

Bundler 4 changed to **2-space indentation**.

### Example (from our project)

```
BUNDLED WITH
  4.0.3
```

This section is always present in lockfiles generated by Bundler >= 1.10.

---

## PLUGIN SOURCE Section

A rarely-used section for gems provided by Bundler plugins (custom source types).

### Structure

```
PLUGIN SOURCE
  remote: <plugin_source_name>
  specs:
    <gem_name> (<version>)
```

This section follows the same indentation rules as GEM/GIT/PATH. It was
introduced in Bundler 1.13 and is only present when a Bundler plugin acts as a
gem source.

For the wow parser, this section should be recognised and either parsed or
gracefully skipped.

---

## Version Constraint Syntax

Version constraints appear in two places:
1. At **6-space indent** as dependencies of a gem spec.
2. At **2-space indent** in the DEPENDENCIES section.

### Operators

| Operator | Name                  | Example        | Meaning                            |
|----------|-----------------------|----------------|------------------------------------|
| (none)   | Exact                 | `= 1.2.3`     | Exactly version 1.2.3             |
| `>=`     | Greater-or-equal      | `>= 1.0`      | Version 1.0 or higher             |
| `>`      | Greater-than          | `> 1.0`       | Strictly above 1.0                |
| `<=`     | Less-or-equal         | `<= 2.0`      | Version 2.0 or lower             |
| `<`      | Less-than             | `< 3.0`       | Strictly below 3.0                |
| `~>`     | Pessimistic (twiddle-wakka) | `~> 2.1` | `>= 2.1.0` and `< 3.0`     |
| `~>`     | Pessimistic (patch)   | `~> 2.1.0`    | `>= 2.1.0` and `< 2.2.0`         |
| `!=`     | Not-equal             | `!= 1.5.0`    | Any version except 1.5.0          |

### Multiple constraints

Multiple constraints can be combined with commas:

```
      activesupport (>= 5.0, < 8.0)
```

### No constraint

A dependency with no version constraint appears as just the name:

```
      nokogiri
```

This is equivalent to `>= 0` (any version).

### Constraint format in specs vs. DEPENDENCIES

In the `specs:` block (6-space indent), constraints describe what a gem
**requires** of its dependencies. In the `DEPENDENCIES` section (2-space
indent), constraints describe what the **user declared** in the Gemfile.

---

## Platform Strings

Platform strings follow the `Gem::Platform` format: `cpu-os` or `cpu-os-version`.

### Common platform strings

| String               | Meaning                                |
|----------------------|----------------------------------------|
| `ruby`               | Generic MRI/CRuby (pure Ruby or source compile) |
| `x86_64-linux`       | 64-bit x86 Linux (generic)             |
| `x86_64-linux-gnu`   | 64-bit x86 Linux (glibc)              |
| `x86_64-linux-musl`  | 64-bit x86 Linux (musl, e.g. Alpine)  |
| `aarch64-linux-gnu`  | 64-bit ARM Linux (glibc)              |
| `aarch64-linux-musl` | 64-bit ARM Linux (musl)               |
| `arm-linux-gnu`      | 32-bit ARM Linux (glibc)              |
| `arm-linux-musl`     | 32-bit ARM Linux (musl)               |
| `x86-linux-gnu`      | 32-bit x86 Linux (glibc)              |
| `x86-linux-musl`     | 32-bit x86 Linux (musl)               |
| `x86_64-darwin`      | 64-bit x86 macOS (Intel)              |
| `arm64-darwin`       | 64-bit ARM macOS (Apple Silicon)       |
| `x86-mingw32`        | 32-bit Windows (MinGW)                 |
| `x64-mingw32`        | 64-bit Windows (MinGW, older)          |
| `x64-mingw-ucrt`     | 64-bit Windows (UCRT, newer)           |
| `java`               | JRuby                                  |
| `universal-darwin`   | macOS universal (uncommon)             |

### Platform in gem version strings

In the `specs:` block, a platform-specific gem is written as
`name (version-platform)`, e.g.:

```
    nokogiri (1.18.7-x86_64-linux-gnu)
```

The dash between version and platform is significant. The parser splits on the
**first** dash that appears **after** the version digits to separate version from
platform.

---

## Edge Cases

### 1. Platform-specific gem variants

A single gem can appear multiple times with different platform suffixes, plus
once without any suffix (the generic/source variant):

```
    ffi (1.17.3)
    ffi (1.17.3-aarch64-linux-gnu)
    ffi (1.17.3-x86_64-darwin)
```

Each variant may have the same or different dependencies.

### 2. Multiple GEM remotes (legacy vs. modern)

**Legacy** (single GEM block, multiple `remote:` lines):
```
GEM
  remote: https://rubygems.org/
  remote: https://gems.example.com/
  specs:
    ...
```

**Modern** (separate GEM blocks per source, Bundler >= 2.2.14):
```
GEM
  remote: https://gems.example.com/
  specs:
    private_gem (1.0)

GEM
  remote: https://rubygems.org/
  specs:
    rack (2.2.3)
```

### 3. Git sources with subdirectories

When a gem lives in a subdirectory of a git repository, the `glob:` field is
used:

```
GIT
  remote: https://github.com/rails/rails.git
  revision: abc123...
  branch: main
  glob: activesupport/*.gemspec
  specs:
    activesupport (8.0.0)
      ...
```

### 4. Dependencies with no version

A gem's dependency can have no version constraint at all:

```
    sdoc (3.0.0.alpha)
      nokogiri
      rdoc (>= 5.0)
```

Here `nokogiri` has no constraint (any version is acceptable).

### 5. Pre-release versions

Pre-release version strings contain letters, e.g.:

```
    rails (8.1.0.alpha)
    devise (5.0.0.beta)
    nokogiri (1.18.0.rc1)
```

These follow `Gem::Version` ordering rules where `.alpha < .beta < .rc < release`.

### 6. Git merge conflicts

The Bundler parser checks for git merge conflict markers (`<<<<<<<`, `=======`,
`>>>>>>>`) and raises `LockfileError` if found. The wow parser should do the
same and provide a clear error message.

### 7. Empty lockfile

An empty or whitespace-only `Gemfile.lock` is valid -- Bundler produces an empty
state with no sources, specs, or dependencies.

### 8. Unknown sections

Bundler gracefully ignores sections it does not recognise (to support forwards
compatibility). The wow parser should do the same -- skip any section whose
header does not match a known section name.

### 9. Three-space vs. two-space BUNDLED WITH / RUBY VERSION

Older Bundler versions (< 4.0) use 3-space indent for values in `BUNDLED WITH`
and `RUBY VERSION`. Bundler 4+ uses 2-space indent. The parser must accept both.

### 10. Blank lines within sections

Source sections (GEM, GIT, PATH) do **not** contain internal blank lines. A
blank line signals the end of the current section. Between sections there is
exactly one blank line.

### 11. Trailing whitespace

Bundler does not produce trailing whitespace, but the parser should be tolerant
of it.

---

## What wow Needs to Implement

### Parser

The parser must handle the indentation-based format:

1. **Tokeniser / line scanner** -- Read the file line by line. For each line,
   determine:
   - Is it a section header? (no leading whitespace, matches a known section
     name)
   - How many leading spaces does it have? (0, 2, 4, or 6)
   - Is it blank? (section separator)

2. **State machine** -- Track the current section (`GEM`, `GIT`, `PATH`,
   `PLATFORMS`, `DEPENDENCIES`, `RUBY VERSION`, `CHECKSUMS`, `BUNDLED WITH`,
   `PLUGIN SOURCE`, or `NULL`/unknown). Within source sections, track whether
   we are reading metadata lines (`remote:`, `revision:`, etc.) or spec lines.

3. **Gem spec parsing** -- From the `NAME_VERSION` regex pattern:
   - 4-space lines: extract gem name, version, and optional platform.
   - 6-space lines: extract dependency name and optional version constraints.

4. **Dependency parsing** -- From the `DEPENDENCIES` section:
   - 2-space lines: extract gem name, optional version constraints, and the
     pinned `!` marker.

5. **Data structures** -- The parser should produce:
   - A list of sources (type: gem/git/path/plugin, with their metadata).
   - For each source, a list of gem specs (name, version, platform, list of
     dependencies with constraints).
   - A list of platforms (strings).
   - A list of top-level dependencies (name, constraints, pinned flag).
   - Optional: Ruby version string.
   - Optional: Bundler version string.
   - Optional: Checksums map (gem identifier -> algorithm + digest).

### Writer

The writer must produce **byte-for-byte identical output** to what Bundler
generates, to avoid unnecessary churn in version control. Key rules:

1. **Section order**: GIT blocks, then PATH blocks, then GEM blocks, then
   PLATFORMS, DEPENDENCIES, RUBY VERSION (if present), CHECKSUMS (if present),
   BUNDLED WITH.

2. **Alphabetical sorting**:
   - Gems within `specs:` are sorted alphabetically by name, then by platform.
   - Platforms are sorted alphabetically.
   - Dependencies are sorted alphabetically.
   - Checksums are sorted alphabetically.
   - `remote:` lines within a GEM block are listed in reverse order (as per
     `Bundler::Source::Rubygems#to_lock`).

3. **Indentation**: Always spaces, never tabs. Use exactly 2, 4, or 6 spaces
   as appropriate.

4. **Blank lines**: Exactly one blank line between sections. No trailing blank
   line at end of file (but a trailing newline after the last content line).

5. **BUNDLED WITH / RUBY VERSION indent**: When **reading**, accept both
   2-space (Bundler 4+) and 3-space (older) indentation in these sections.
   When **writing new lockfiles**, always use 2-space indent (Bundler 4+
   style) — wow is the new tool and should not perpetuate legacy quirks.

6. **Trailing newline**: File ends with `\n` after the last line of content.

### Implementation notes for C

- Lines are short (typically < 200 characters). A fixed-size line buffer of
  512 or 1024 bytes should suffice with a check for overflow.
- The format is strictly line-oriented -- no need for multi-line parsing.
- Leading-space counting is the primary structural signal. A simple
  `count_leading_spaces()` function covers most of the parsing logic.
- Version constraint strings contain only printable ASCII characters.
- Gem names may contain letters, digits, hyphens, and underscores.
- SHA-256 checksums are always exactly 64 hex characters.

---

## Real-World Examples

### A. Small gem with platform-specific variants (our project)

```
GEM
  remote: https://rubygems.org/
  specs:
    ffi (1.17.3)
    ffi (1.17.3-aarch64-linux-gnu)
    ffi (1.17.3-aarch64-linux-musl)
    ffi (1.17.3-arm-linux-gnu)
    ffi (1.17.3-arm-linux-musl)
    ffi (1.17.3-arm64-darwin)
    ffi (1.17.3-x86-linux-gnu)
    ffi (1.17.3-x86-linux-musl)
    ffi (1.17.3-x86_64-darwin)
    ffi (1.17.3-x86_64-linux-gnu)
    ffi (1.17.3-x86_64-linux-musl)
    rb-inotify (0.11.1)
      ffi (~> 1.0)

PLATFORMS
  aarch64-linux-gnu
  aarch64-linux-musl
  arm-linux-gnu
  arm-linux-musl
  arm64-darwin
  ruby
  x86-linux-gnu
  x86-linux-musl
  x86_64-darwin
  x86_64-linux-gnu
  x86_64-linux-musl

DEPENDENCIES
  rb-inotify

CHECKSUMS
  ffi (1.17.3) sha256=0e9f39f7bb3934f77ad6feab49662be77e87eedcdeb2a3f5c0234c2938563d4c
  ffi (1.17.3-aarch64-linux-gnu) sha256=28ad573df26560f0aedd8a90c3371279a0b2bd0b4e834b16a2baa10bd7a97068
  rb-inotify (0.11.1) sha256=a0a700441239b0ff18eb65e3866236cd78613d6b9f78fea1f9ac47a85e47be6e

BUNDLED WITH
  4.0.3
```

### B. Gem with PATH source (e.g. Devise developing locally)

```
PATH
  remote: .
  specs:
    devise (5.0.0.beta)
      bcrypt (~> 3.0)
      orm_adapter (~> 0.1)
      railties (>= 6.0.0)
      responders
      warden (~> 1.2.3)

GIT
  remote: https://github.com/rails/rails-controller-testing.git
  revision: c203673f8011a7cdc2a8edf995ae6b3eec3417ca
  specs:
    rails-controller-testing (1.0.5)
      actionpack (>= 5.0.1.rc1)
      actionview (>= 5.0.1.rc1)
      activesupport (>= 5.0.1.rc1)

GEM
  remote: https://rubygems.org/
  specs:
    actionpack (7.1.0)
      actionview (= 7.1.0)
      activesupport (= 7.1.0)
      rack (~> 2.2, >= 2.2.4)
    bcrypt (3.1.19)
    orm_adapter (0.5.0)
    rack (2.2.8)
    warden (1.2.9)
      rack (>= 2.0.9)

PLATFORMS
  ruby
  x86_64-linux

DEPENDENCIES
  bcrypt (~> 3.0)
  devise!
  rails-controller-testing!

BUNDLED WITH
  2.5.3
```

Note how `devise!` and `rails-controller-testing!` have the `!` pinned marker
because they come from PATH and GIT sources respectively.

### C. Rails framework monorepo (GIT + PATH + GEM)

```
GIT
  remote: https://github.com/rails/sdoc.git
  revision: cd75e36ce2d1acb66734c1390ffe33aa05479380
  branch: main
  specs:
    sdoc (3.0.0.alpha)
      nokogiri
      rdoc (>= 5.0)
      rouge

PATH
  remote: .
  specs:
    actioncable (8.1.0.alpha)
      actionpack (= 8.1.0.alpha)
      activesupport (= 8.1.0.alpha)
      nio4r (~> 2.0)
      websocket-driver (>= 0.6.1)
      zeitwerk (~> 2.6)
    actionmailer (8.1.0.alpha)
      actionpack (= 8.1.0.alpha)
      actionview (= 8.1.0.alpha)
      activejob (= 8.1.0.alpha)
      activesupport (= 8.1.0.alpha)
      mail (>= 2.8.0)
      rails-dom-testing (~> 2.2)

GEM
  remote: https://rubygems.org/
  specs:
    nio4r (2.7.0)
    nokogiri (1.18.7)
      racc (~> 1.4)
    nokogiri (1.18.7-arm64-darwin)
      racc (~> 1.4)
    nokogiri (1.18.7-x86_64-linux-gnu)
      racc (~> 1.4)
    racc (1.8.1)
    rack (3.1.7)
    websocket-driver (0.7.6)
      websocket-extensions (>= 0.1.0)
    websocket-extensions (0.1.5)
    zeitwerk (2.7.1)

PLATFORMS
  arm64-darwin
  ruby
  x86_64-linux-gnu

DEPENDENCIES
  actioncable!
  actionmailer!
  nokogiri (>= 1.8.1)
  sdoc!

RUBY VERSION
  ruby 3.2.2

BUNDLED WITH
  2.5.3
```

### D. Multiple constraints in DEPENDENCIES

```
DEPENDENCIES
  rails (~> 7.0)
  sidekiq (>= 6.0, < 8.0)
  puma (~> 5.0, >= 5.6.4)
  pg (~> 1.1)
```

### E. Sinatra-style minimal lockfile

```
GEM
  remote: https://rubygems.org/
  specs:
    mustermann (3.0.0)
      ruby2_keywords (~> 0.0.1)
    rack (2.2.8)
    rack-protection (3.1.0)
      base64 (>= 0.1.0)
      rack (~> 2.2, >= 2.2.4)
    ruby2_keywords (0.0.5)
    sinatra (3.1.0)
      mustermann (~> 3.0)
      rack (~> 2.2, >= 2.2.4)
      rack-protection (= 3.1.0)
      tilt (~> 2.0)
    tilt (2.3.0)

PLATFORMS
  ruby

DEPENDENCIES
  sinatra (~> 3.0)

BUNDLED WITH
  2.4.19
```

---

## Sources

### Bundler Source Code (canonical reference)

- [ruby/ruby -- lib/bundler/lockfile_parser.rb](https://github.com/ruby/ruby/blob/master/lib/bundler/lockfile_parser.rb) -- the canonical parser
- [rubygems/bundler -- lib/bundler/lockfile_parser.rb](https://github.com/rubygems/bundler/blob/master/lib/bundler/lockfile_parser.rb) -- legacy bundler repo
- [Bundler::Source::Git (ruby-doc.org)](https://ruby-doc.org/3.2.5/stdlibs/bundler/Bundler/Source/Git.html) -- `to_lock` for GIT sections
- [Bundler::Source::Path (ruby-doc.org)](https://ruby-doc.org/3.3/stdlibs/bundler/Bundler/Source/Path.html) -- `to_lock` for PATH sections
- [Bundler::LockfileParser (ruby-doc.org)](https://ruby-doc.org/3.0.6/stdlibs/bundler/Bundler/LockfileParser.html) -- class documentation

### Bundler Documentation

- [Bundler -- How to install gems from git repositories](https://bundler.io/guides/git.html)
- [Bundler -- Gemfile format specification](https://bundler.io/man/gemfile.5.html)
- [Bundler v2.6 -- Lockfile checksums announcement](https://bundler.io/blog/2024/12/19/bundler-v2-6.html)
- [Upgrading to RubyGems/Bundler 4](https://blog.rubygems.org/2025/12/03/upgrade-to-rubygems-bundler-4.html)

### Blog Posts and Guides

- [The Ultimate Guide to Gemfile and Gemfile.lock (Saeloun)](https://blog.saeloun.com/2022/08/16/understanding-gemfile-and-gemfile-lock/)
- [Understanding the Gemfile.lock File (Moncef Belyamani)](https://www.moncefbelyamani.com/understanding-the-gemfile-lock-file/)
- [Installing Precompiled Native Gems with bundle lock --add-platform (Arkency)](https://blog.arkency.com/installing-precompiled-native-gems-with-bundle-lock-add-platform/)
- [RubyGems Patterns Guide -- version constraints](https://guides.rubygems.org/patterns/)
- [Ruby's Pessimistic Operator (thoughtbot)](https://thoughtbot.com/blog/rubys-pessimistic-operator)
- [Bundler Checksums -- The Silent Guardian (Mensfeld)](https://mensfeld.pl/2025/01/the-silent-guardian-why-bundler-checksums-are-a-game-changer-for-your-applications/)

### GitHub Issue/PR References

- [Bundler issue #5923 -- Order of Gemfile.lock differs between Bundler 1 and 2](https://github.com/rubygems/bundler/issues/5923)
- [Bundler issue #4238 -- Exclamation marks in DEPENDENCIES](https://github.com/rubygems/bundler/issues/4238)
- [rubygems PR #9076 -- Fix triple spacing when generating lockfile](https://github.com/ruby/rubygems/pull/9076)
- [rubygems PR #4647 -- Auto-update insecure lockfile to split GEM source sections](https://github.com/rubygems/rubygems/pull/4647)
