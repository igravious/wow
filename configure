#!/bin/sh
# configure — detect Cosmopolitan toolchain and generate config.mk
set -e

usage() {
    cat <<EOF
Usage: ./configure [OPTIONS]

Options:
  --with-cosmo-src=DIR   Path to Cosmopolitan source tree
  --with-cosmocc=DIR     Path to cosmocc toolchain directory
  --help                 Show this help

Environment variables (override auto-detection):
  COSMO_SRC              Cosmopolitan source tree
  COSMO                  cosmocc toolchain directory

If not specified, configure will attempt to find cosmocc in PATH
and derive paths automatically.
EOF
    exit 0
}

# Defaults — empty means auto-detect
opt_cosmo_src=""
opt_cosmocc=""

# Parse arguments
for arg in "$@"; do
    case "$arg" in
        --with-cosmo-src=*)
            opt_cosmo_src="${arg#--with-cosmo-src=}"
            ;;
        --with-cosmocc=*)
            opt_cosmocc="${arg#--with-cosmocc=}"
            ;;
        --help|-h)
            usage
            ;;
        *)
            echo "error: unknown option: $arg" >&2
            echo "Try './configure --help' for usage." >&2
            exit 1
            ;;
    esac
done

# Step 1: Find cosmocc binary
cosmocc_bin=""
if [ -n "$opt_cosmocc" ]; then
    cosmocc_bin="$opt_cosmocc/bin/cosmocc"
elif [ -n "$COSMO" ]; then
    cosmocc_bin="$COSMO/bin/cosmocc"
else
    # Try PATH
    cosmocc_bin=$(command -v cosmocc 2>/dev/null || true)
fi

if [ -z "$cosmocc_bin" ] || [ ! -x "$cosmocc_bin" ]; then
    echo "error: cosmocc not found." >&2
    echo "" >&2
    echo "Install Cosmopolitan and either:" >&2
    echo "  1. Add cosmocc to your PATH" >&2
    echo "  2. Run: ./configure --with-cosmocc=/path/to/.cosmocc/VERSION" >&2
    echo "  3. Set COSMO=/path/to/.cosmocc/VERSION" >&2
    exit 1
fi

# Resolve to absolute path
cosmocc_bin=$(cd "$(dirname "$cosmocc_bin")" && pwd)/$(basename "$cosmocc_bin")
echo "Found cosmocc: $cosmocc_bin"

# Step 2: Derive cosmocc toolchain directory (parent of bin/)
cosmo_dir=$(dirname "$(dirname "$cosmocc_bin")")
if [ -n "$opt_cosmocc" ]; then
    cosmo_dir=$(cd "$opt_cosmocc" && pwd)
fi
echo "Toolchain dir: $cosmo_dir"

# Step 3: Find Cosmopolitan source tree
cosmo_src=""
if [ -n "$opt_cosmo_src" ]; then
    cosmo_src=$(cd "$opt_cosmo_src" && pwd)
elif [ -n "$COSMO_SRC" ]; then
    cosmo_src=$(cd "$COSMO_SRC" && pwd)
else
    # Heuristic: cosmocc is typically at $COSMO_SRC/.cosmocc/VERSION/bin/cosmocc
    # So go up 3 levels from the toolchain dir
    candidate=$(dirname "$(dirname "$cosmo_dir")")
    if [ -f "$candidate/net/https/https.h" ]; then
        cosmo_src="$candidate"
    fi
fi

if [ -z "$cosmo_src" ] || [ ! -f "$cosmo_src/net/https/https.h" ]; then
    echo "error: Cosmopolitan source tree not found." >&2
    echo "" >&2
    echo "The source tree is needed for mbedTLS/HTTPS headers." >&2
    echo "Either:" >&2
    echo "  1. Run: ./configure --with-cosmo-src=/path/to/cosmopolitan" >&2
    echo "  2. Set COSMO_SRC=/path/to/cosmopolitan" >&2
    exit 1
fi
echo "Cosmo source:  $cosmo_src"

# Step 4: Generate config.mk
cat > config.mk <<EOF
# Generated by ./configure — do not edit
COSMO     = $cosmo_dir
COSMO_SRC = $cosmo_src
EOF

echo ""
echo "Configuration written to config.mk"
echo "Run 'make' to build."
